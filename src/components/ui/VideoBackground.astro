---
interface Props {
    src: string;
    poster?: string;
    overlay?: 'light' | 'medium' | 'heavy';
    class?: string;
}

const {
    src,
    poster,
    overlay = 'medium',
    class: className = ''
} = Astro.props;

const overlayOpacity = {
    light: 'bg-dark/60',
    medium: 'bg-dark/75',
    heavy: 'bg-dark/85'
};
---

<div class={`video-background absolute inset-0 -z-10 overflow-hidden ${className}`}>
    <!-- Video element -->
    <video
        autoplay
        muted
        loop
        playsinline
        preload="metadata"
        poster={poster}
        class="absolute w-full h-full object-cover"
        data-src={src}
    >
        <source src={src} type="video/mp4" />
    </video>

    <!-- Overlay for better text readability -->
    <div class={`absolute inset-0 ${overlayOpacity[overlay]}`}></div>

    <!-- Gradient overlay for smooth edges -->
    <div class="absolute inset-0 bg-gradient-to-b from-dark/50 via-transparent to-dark"></div>
</div>

<style>
    .video-background video {
        filter: brightness(0.8) saturate(1.1);
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
        .video-background video {
            display: none;
        }
    }
</style>

<script>
    function initVideoBackgrounds() {
        const videos = document.querySelectorAll('.video-background video') as NodeListOf<HTMLVideoElement>;

        videos.forEach((video) => {
            // Get source from data attribute or source element
            const src = video.dataset.src || video.querySelector('source')?.getAttribute('src');
            if (src && !video.src.includes(src)) {
                video.src = src;
            }

            video.load();
            video.currentTime = 0;

            // Small delay to ensure DOM is ready
            requestAnimationFrame(() => {
                video.play().catch(() => {
                    // Autoplay was prevented, that's okay
                });
            });
        });
    }

    function cleanupVideoBackgrounds() {
        const videos = document.querySelectorAll('.video-background video') as NodeListOf<HTMLVideoElement>;
        videos.forEach((video) => {
            video.pause();
            video.removeAttribute('src');
            video.load(); // Reset the video element
        });
    }

    // Run on initial load
    initVideoBackgrounds();

    // Cleanup videos before swap to prevent blocking
    document.addEventListener('astro:before-swap', cleanupVideoBackgrounds);

    // Re-run after View Transitions swap
    document.addEventListener('astro:after-swap', initVideoBackgrounds);
</script>

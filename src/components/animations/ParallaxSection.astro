---
interface Props {
    speed?: number;
    class?: string;
}

const {
    speed = 0.5,
    class: className = ''
} = Astro.props;
---

<div
    class={`parallax-section ${className}`}
    data-animate="parallax"
    data-speed={speed}
>
    <slot />
</div>

<script>
    function initParallax() {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) return;

        const parallaxElements = document.querySelectorAll('[data-animate="parallax"]');
        if (!parallaxElements.length) return;

        let lastScrollY = 0;
        let ticking = false;

        function handleScroll() {
            const scrolled = window.pageYOffset;
            if (Math.abs(scrolled - lastScrollY) < 5) {
                ticking = false;
                return;
            }
            lastScrollY = scrolled;

            parallaxElements.forEach((element) => {
                const speed = parseFloat(element.getAttribute('data-speed') || '0.5');
                const rect = element.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    const rate = scrolled * speed;
                    (element as HTMLElement).style.transform = `translate3d(0, ${rate}px, 0)`;
                }
            });
            ticking = false;
        }

        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(handleScroll);
                ticking = true;
            }
        }, { passive: true });
    }

    initParallax();
    document.addEventListener('astro:after-swap', initParallax);
</script>

<style>
    .parallax-section {
        will-change: transform;
        contain: layout style;
    }
</style>
